/****************************************/
//------------PJAX ENABLER--------------//
/****************************************/
function initializeApplication() {
    $(document).on('page:fetch', function () {
        NProgress.start();
    });
    $(document).on('page:change', function () {
        NProgress.done();
    });
    $(document).on('page:restore', function () {
        NProgress.remove();
    });

    $.pjax.defaults.timeout = 2000;
    $.pjax.defaults.maxCacheLength = 0;
    $(document).pjax("a:not([data-no-pjax])", '[data-pjax-container]')

    $("a").on('pjax:complete', function () {
        NProgress.done();
    });

    $(document).on('pjax:complete', function () {
        NProgress.done();
        switchContainer();
        $('#error_callout').fadeTo('fast', 0);
        bind_notification();

        try {
            initLoginBoxValidation();
        } catch (err) {
        }
    });

    window.addEventListener('popstate', function (e) {
        getViewportHeight();
        switchContainer();
        try {
            initLoginBoxValidation();
        } catch (err) {
        }
    });

    $("html").on("keydown", function (e) {
        if (e.keyCode == 32 && e.target == document.body) {
            e.preventDefault();
            return false;
        }
    });

    $(document).on('pjax:beforeSend', function () {
        NProgress.start();
        $('.header_btns').hide();
    });

    $(document).on('submit', 'form[data-pjax]', function (event) {
        $.pjax.submit(event, '#wrap');
    });

    $(window).resize(function () {
        getViewportHeight();
        switchContainer();
    });

    $('body').on('hidden.bs.modal', '#modal', function () {
        $('.modal-dialog').removeClass('modal-mg');
        $(this).removeData('bs.modal');
    });

    if (("onhashchange" in window)) {
        $(window).bind('hashchange', function () {
            window.location.hash = ''
        });
    }

    getViewportHeight();
    switchContainer();
    try {
        initLoginBoxValidation();
    } catch (err) {
    }

    bind_notification();
}

// For centering login form
var getViewportHeight = function () {
    $('.focusedform').css('height', $(window).height() - 40); // Prevent scroll of the whole content (mobile)
};


function switchContainer() {
    var animationSpeed = 300;

    var is_confirmation = $('#new_user_confirmation').length > 0;
    var is_login = $('#new_user_session').length > 0;
    var is_recover = $('#new_user_password').length > 0;
    var is_edit_register = $('#edit_user_password').length > 0;
    var is_register = $('#new_user_registration').length > 0;
    var cheight = 100;

    if (is_login)
        cheight = 314;
    else if (is_register && window.innerWidth < 768)
        cheight = 340;
    else if (is_register && window.innerWidth >= 768)
        cheight = 446;
    else if (is_recover || is_confirmation)
        cheight = 260;
    else if (is_edit_register)
        cheight = 305;

    $('#loginbox').animate({'height': cheight + 'px'}, animationSpeed, function () {
        $('#loginbox form').fadeTo(animationSpeed, 1);
    });
}

/******************************************/
//------------Notifications---------------//
/******************************************/
function bind_notification() {
    $.ajax({
        type: 'GET',
        url: '/notifications',
        data: 'referer=2',
        beforeSend: function () {
            $("#notification_panel").html("<div style='width: 100%; text-align: center; font-style: italic;'><img src='/assets/ajax-loader.gif' alt='Loading...' title='Loading...'/></div>");
            $('#notification_div').hide();
        },
        success: function (html) {
            $('#notification_panel').html(html);
        }
    });
}

/******************************************/
//------------ERROR MESSAGES--------------//
/******************************************/
function showNotificationMsg(message) {
    hideProcessingMsg();
    hideErrorMsg();
    var notficationMsgBox = $('#notification_msg_box');
    notficationMsgBox.children('span').html(message);
    notficationMsgBox.fadeIn(1000);
}

function showErrorMsg(message) {
    hideProcessingMsg();
    hideNotificationMsg();
    var errorMsgBox = $('#error_message_box');
    errorMsgBox.children('span').html(message);
    errorMsgBox.fadeIn(1000);
}

function showProcessingMsg(message) {
    hideNotificationMsg();
    hideErrorMsg();
    var processing_msg_box = $('#processing_msg_box');
    processing_msg_box.children('span').html(message);
    processing_msg_box.fadeIn(1000);
}

function hideProcessingMsg() {
    $('#processing_msg_box').hide();
}

function hideNotificationMsg() {
    $('#notfication_msg_box').hide();
}

function hideErrorMsg() {
    $('#error_message_box').hide();
}

function setAutoHideFlashMsg(id) {
    $('#' + id + '_close').click(function () {
        $('#' + id).hide();
    });

    var observer = new MutationObserver(function (mutations) {
        setTimeout(function () {
            $('#' + id).fadeOut('slow');
        }, 5000);
    });

    var target = document.getElementById(id);
    observer.observe(target, {attributes: true, attributeFilter: ['style']});
}


/******************************************/
//------------ERROR MESSAGES--------------//
/******************************************/
function loadApplicationLayout() {
    /**
     * Resize function without multiple trigger
     *
     * Usage:
     * $(window).smartresize(function(){
 *     // code here
 * });
     */
    (function ($, sr) {
        // debouncing function from John Hann
        // http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/
        var debounce = function (func, threshold, execAsap) {
            var timeout;

            return function debounced() {
                var obj = this, args = arguments;

                function delayed() {
                    if (!execAsap)
                        func.apply(obj, args);
                    timeout = null;
                }

                if (timeout)
                    clearTimeout(timeout);
                else if (execAsap)
                    func.apply(obj, args);

                timeout = setTimeout(delayed, threshold || 100);
            };
        };

        // smartresize
        jQuery.fn[sr] = function (fn) {
            return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr);
        };

    })(jQuery, 'smartresize');
    /**
     * To change this license header, choose License Headers in Project Properties.
     * To change this template file, choose Tools | Templates
     * and open the template in the editor.
     */

    var CURRENT_URL = window.location.href.split('#')[0].split('?')[0],
        $BODY = $('body'),
        $MENU_TOGGLE = $('#menu_toggle'),
        $SIDEBAR_MENU = $('#sidebar-menu'),
        $SIDEBAR_FOOTER = $('.sidebar-footer'),
        $LEFT_COL = $('.left_col'),
        $RIGHT_COL = $('.right_col'),
        $NAV_MENU = $('.nav_menu'),
        $FOOTER = $('footer');


    // Sidebar
    function init_sidebar() {
        // TODO: This is some kind of easy fix, maybe we can improve this
        var setContentHeight = function () {
            // reset height
//            $RIGHT_COL.css('min-height', $(window).height());
//
//            var bodyHeight = $BODY.outerHeight(),
//                footerHeight = $BODY.hasClass('footer_fixed') ? -10 : $FOOTER.height(),
//                leftColHeight = $LEFT_COL.eq(1).height() + $SIDEBAR_FOOTER.height(),
//                contentHeight = bodyHeight < leftColHeight ? leftColHeight : bodyHeight;
//
//            // normalize content
//            contentHeight -= $NAV_MENU.height() + footerHeight;
//
//            $RIGHT_COL.css('min-height', contentHeight);
        };

        $SIDEBAR_MENU.find('a').on('click', function (ev) {
            console.log('clicked - sidebar_menu');
            var $li = $(this).parent();

            if ($li.is('.active')) {
                $li.removeClass('active active-sm');
                $('ul:first', $li).slideUp(function () {
                    setContentHeight();
                });
            } else {
                // prevent closing menu if we are on child menu
                if (!$li.parent().is('.child_menu')) {
                    $SIDEBAR_MENU.find('li').removeClass('active active-sm');
                    $SIDEBAR_MENU.find('li ul').slideUp();
                } else {
                    if ($BODY.is(".nav-sm")) {
                        $SIDEBAR_MENU.find("li").removeClass("active active-sm");
                        $SIDEBAR_MENU.find("li ul").slideUp();
                    }
                }

                $SIDEBAR_MENU.find('a[href="' + $(this).attr('href') + '"]').parent('li').addClass('active active-sm');

                $SIDEBAR_MENU.find('a').filter(function () {
                    return this.href == $(this).attr('href');
                }).parent('li').addClass('active active-sm').parents('ul').slideDown(function () {
                    setContentHeight();
                }).parent().addClass('active active-sm');

//                $li.addClass('active');

                $('ul:first', $li).slideDown(function () {
                    setContentHeight();
                });
            }
        });

        // toggle small or large menu
        $MENU_TOGGLE.on('click', function () {
            console.log('clicked - menu toggle');

            if ($BODY.hasClass('nav-md')) {
                $SIDEBAR_MENU.find('li.active ul').hide();
                $SIDEBAR_MENU.find('li.active').addClass('active-sm').removeClass('active');
            } else {
                $SIDEBAR_MENU.find('li.active-sm ul').show();
                $SIDEBAR_MENU.find('li.active-sm').addClass('active').removeClass('active-sm');
            }

            $BODY.toggleClass('nav-md nav-sm');

            setContentHeight();

            $.pjax.reload('[data-pjax-container]');
        });

        // check active menu
        $SIDEBAR_MENU.find('a[href="' + CURRENT_URL + '"]').parent('li').addClass('active active-sm');

        $SIDEBAR_MENU.find('a').filter(function () {
            return this.href == CURRENT_URL;
        }).parent('li').addClass('active active-sm').parents('ul').slideDown(function () {
            setContentHeight();
        }).parent().addClass('active active-sm');

        // recompute content when resizing
        $(window).smartresize(function () {
            setContentHeight();
            $.pjax.reload('[data-pjax-container]');

        });

        setContentHeight();

        // fixed sidebar
        if ($.fn.mCustomScrollbar) {
            $('.menu_fixed').mCustomScrollbar({
                autoHideScrollbar: true,
                theme: 'minimal',
                mouseWheel: {preventDefault: true}
            });
        }
    };

    init_sidebar();
}